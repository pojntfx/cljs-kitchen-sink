{"version":3,"sources":["reitit/coercion/spec.cljc"],"mappings":"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","names":["reitit.coercion.spec/string-transformer","spec_tools.core.type_transformer","spec-tools.core/strip-extra-keys-transformer","spec-tools.core/string-transformer","reitit.coercion.spec/json-transformer","spec-tools.core/json-transformer","reitit.coercion.spec/strip-extra-keys-transformer","reitit.coercion.spec/no-op-transformer","reitit.coercion.spec/t_reitit$coercion$spec15257","_","reitit$coercion$spec$IntoSpec$into_spec$dyn","x__5393__auto__","m__5394__auto__","reitit.coercion.spec/into-spec","goog/typeOf","m__5392__auto__","cljs.core/missing-protocol","reitit.coercion.spec/IntoSpec","this","name","reitit.coercion.spec/ensure-name","?name","or__5045__auto__","cljs.core.keyword","cljs.core/name","cljs.core.gensym","cljs.core/PROTOCOL_SENTINEL","cljs.core/PersistentArrayMap","cljs.core.dissoc","spec_tools.data_spec.spec","cljs.core/PersistentHashMap","cljs.core/PersistentVector","spec-tools.data-spec/Maybe","spec-tools.core/Spec","spec-tools.core/create-spec","reitit.coercion.spec/stringify-pred","pred","cljs.core/seq?","cljs.core/seq","js/reitit","js/reitit.coercion","js/reitit.coercion.spec","js/reitit.coercion.spec.coerce-response?","method-table__5642__auto__","cljs.core.atom","prefer-table__5643__auto__","method-cache__5644__auto__","cached-hierarchy__5645__auto__","hierarchy__5646__auto__","cljs.core.get","fexpr__15263","cljs.core/MultiFn","cljs.core.symbol","reitit.coercion.spec/coerce-response?","cljs.core/identity","reitit.coercion.spec/default-options","p__15266","map__15267","cljs.core/--destructure-map","reitit.coercion.spec/create","transformers","coerce-response?","opts","reitit.coercion.spec/t_reitit$coercion$spec15268","specification","parameters","responses","G__15273","cljs.core/Keyword","spec_tools.swagger.core.swagger_spec","cljs.core.merge","cljs.core.into","cljs.core/empty","iter__5523__auto__","s__15275","cljs.core/LazySeq","temp__5804__auto__","cljs.core/chunked-seq?","c__5521__auto__","size__5522__auto__","cljs.core/count","b__15277","cljs.core/chunk-buffer","i__15276","vec__15278","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__15274","cljs.core/chunk-rest","vec__15281","cljs.core/first","cljs.core/cons","cljs.core/rest","k","v","s__15285","b__15287","i__15286","vec__15288","iter__15284","vec__15291","response","$","clojure.set/rename-keys","p1__15264#","cljs.core.update","cljs.core.ex_info","model","spec","error","problems","cljs.core.comp","cljs.core/str","cljs.spec.alpha/form","cljs.core.assoc","p1__15265#","cljs.core.mapv","type","map__15301","formats","default","value","format","temp__5802__auto__","transformer","coerced","spec_tools.core.coerce","cljs.spec.alpha.valid_QMARK_","transformed","spec_tools.core.conform","cljs.spec.alpha/invalid?","spec_tools.core.explain_data","reitit.coercion/map->CoercionError","cljs.spec.alpha/unform","reitit.coercion.spec/coercion","cljs.core/chunk-first"],"sourcesContent":["(ns reitit.coercion.spec\n  (:require [clojure.set :as set]\n            [clojure.spec.alpha :as s]\n            [reitit.coercion :as coercion]\n            [spec-tools.core :as st #?@(:cljs [:refer [Spec]])]\n            [spec-tools.data-spec :as ds #?@(:cljs [:refer [Maybe]])]\n            [spec-tools.swagger.core :as swagger])\n  #?(:clj\n     (:import (spec_tools.core Spec)\n              (spec_tools.data_spec Maybe))))\n\n(def string-transformer\n  (st/type-transformer\n   st/strip-extra-keys-transformer\n   st/string-transformer))\n\n(def json-transformer\n  (st/type-transformer\n   st/strip-extra-keys-transformer\n   st/json-transformer))\n\n(def strip-extra-keys-transformer\n  st/strip-extra-keys-transformer)\n\n(def no-op-transformer\n  (reify\n    st/Transformer\n    (-name [_] ::no-op)\n    (-encoder [_ _ _])\n    (-decoder [_ _ _])))\n\n(defprotocol IntoSpec\n  (into-spec [this name]))\n\n(defn- ensure-name [?name]\n  (or ?name (keyword \"spec\" (name (gensym \"\")))))\n\n(extend-protocol IntoSpec\n\n  #?(:clj  clojure.lang.PersistentArrayMap\n     :cljs cljs.core.PersistentArrayMap)\n  (into-spec [this name]\n    (dissoc (ds/spec (ensure-name name) this) :name))\n\n  #?(:clj  clojure.lang.PersistentHashMap\n     :cljs cljs.core.PersistentHashMap)\n  (into-spec [this name]\n    (dissoc (ds/spec (ensure-name name) this) :name))\n\n  #?(:clj  clojure.lang.PersistentVector\n     :cljs cljs.core.PersistentVector)\n  (into-spec [this name]\n    (dissoc (ds/spec (ensure-name name) this) :name))\n\n  Maybe\n  (into-spec [this name]\n    (ds/spec (ensure-name name) this))\n\n  Spec\n  (into-spec [this _] this)\n\n  #?(:clj  Object\n     :cljs default)\n  (into-spec [this _]\n    (st/create-spec {:spec this}))\n\n  nil\n  (into-spec [this _]))\n\n(defn stringify-pred [pred]\n  (str (if (seq? pred) (seq pred) pred)))\n\n(defmulti coerce-response? identity :default ::default)\n(defmethod coerce-response? ::default [_] true)\n\n(def default-options\n  {:coerce-response? coerce-response?\n   :transformers {:body {:default strip-extra-keys-transformer\n                         :formats {\"application/json\" json-transformer}}\n                  :string {:default string-transformer}\n                  :response {:default no-op-transformer}}})\n\n(defn create [{:keys [transformers coerce-response?] :as opts}]\n  ^{:type ::coercion/coercion}\n  (reify coercion/Coercion\n    (-get-name [_] :spec)\n    (-get-options [_] opts)\n    (-get-apidocs [this specification {:keys [parameters responses]}]\n      (case specification\n        :swagger (swagger/swagger-spec\n                  (merge\n                   (if parameters\n                     {::swagger/parameters\n                      (into\n                       (empty parameters)\n                       (for [[k v] parameters]\n                         [k (coercion/-compile-model this v nil)]))})\n                   (if responses\n                     {::swagger/responses\n                      (into\n                       (empty responses)\n                       (for [[k response] responses]\n                         [k (as-> response $\n                              (set/rename-keys $ {:body :schema})\n                              (if (:schema $)\n                                (update $ :schema #(coercion/-compile-model this % nil))\n                                $))]))})))\n        (throw\n         (ex-info\n          (str \"Can't produce Spec apidocs for \" specification)\n          {:specification specification, :coercion :spec}))))\n    (-compile-model [_ model name]\n      (into-spec model name))\n    (-open-model [_ spec] spec)\n    (-encode-error [_ error]\n      (let [problems (-> error :problems ::s/problems)]\n        (-> error\n            (update :spec (comp str s/form))\n            (assoc :problems (mapv #(update % :pred stringify-pred) problems)))))\n    (-request-coercer [this type spec]\n      (let [spec (coercion/-compile-model this spec nil)\n            {:keys [formats default]} (transformers type)]\n        (fn [value format]\n          (if-let [transformer (or (get formats format) default)]\n            (let [coerced (st/coerce spec value transformer)]\n              (if (s/valid? spec coerced)\n                coerced\n                (let [transformed (st/conform spec coerced transformer)]\n                  (if (s/invalid? transformed)\n                    (let [problems (st/explain-data spec coerced transformer)]\n                      (coercion/map->CoercionError\n                       {:spec spec\n                        :problems problems}))\n                    (s/unform spec transformed)))))\n            value))))\n    (-response-coercer [this spec]\n      (if (coerce-response? spec)\n        (coercion/-request-coercer this :response spec)))))\n\n(def coercion (create default-options))\n"]}